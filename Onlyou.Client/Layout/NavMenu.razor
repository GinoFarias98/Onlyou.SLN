@using Microsoft.AspNetCore.Components.Rendering
@using Onlyou.Client.Pages.AutorizacionPages
@using System.Security.Claims
@inject NavigationManager Navigation

<style>
    .navmenu-content {
        flex: 1;
    }

    .logout-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    .navmenu-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px 15px;
        text-align: center;
        z-index: 100;
    }

    .papelera-link {
        color: #dc3545 !important;
        border-left: 3px solid #dc3545;
        margin-top: 10px;
        padding-left: 12px !important;
    }

        .papelera-link:hover {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: #bd2130 !important;
        }
</style>

<div class="navmenu-onlyou">
    <div class="navmenu-content">

        <a class="nav-link" href="/">
            <i class="bi bi-house-door-fill"></i> Inicio
        </a>

        <AuthorizeView>
            <Authorized>

                <!-- Administrar Catálogo -->
                <div class="nav-item">
                    <div class="nav-link catalog-toggle" @onclick="ToggleCatalogMenu">
                        <div class="toggle-content">
                            <i class="bi bi-grid-1x2-fill"></i>
                            <span>Administrar Catálogo</span>
                            <i class="bi bi-chevron-@(showCatalogMenu ? "down" : "right")"></i>
                        </div>
                    </div>

                    @if (showCatalogMenu)
                    {
                        <div class="submenu">
                            <a class="submenu-link" href="productosV2" @onclick="CloseAllMenus"><i class="bi bi-box-fill"></i> Productos</a>
                            <a class="submenu-link" href="categorias" @onclick="CloseAllMenus"><i class="bi bi-tags-fill"></i> Categorías</a>
                            <a class="submenu-link" href="colores" @onclick="CloseAllMenus"><i class="bi bi-palette-fill"></i> Colores</a>
                            <a class="submenu-link" href="tipo-productos" @onclick="CloseAllMenus"><i class="bi bi-box-seam"></i> Tipo Productos</a>
                            <a class="submenu-link" href="talles" @onclick="CloseAllMenus"><i class="bi bi-rulers"></i> Talles</a>
                            <a class="submenu-link" href="marcas" @onclick="CloseAllMenus"><i class="bi bi-star-fill"></i> Marcas</a>
                            <a class="submenu-link" href="proveedores" @onclick="CloseAllMenus"><i class="bi bi-people"></i> Proveedores</a>
                        </div>
                    }
                </div>

                <!-- Administrar Caja -->
                <div class="nav-item">
                    <div class="nav-link catalog-toggle" @onclick="ToggleCajaMenu">
                        <div class="toggle-content">
                            <i class="bi bi-cash-stack"></i>
                            <span>Administrar Caja</span>
                            <i class="bi bi-chevron-@(showCajaMenu ? "down" : "right")"></i>
                        </div>
                    </div>

                    @if (showCajaMenu)
                    {
                        <div class="submenu">
                            <a class="submenu-link" href="caja" @onclick="CloseAllMenus"><i class="bi bi-currency-dollar"></i> Caja</a>
                            <a class="submenu-link" href="TipoMovimientos" @onclick="CloseAllMenus"><i class="bi bi-tags-fill"></i> Tipo de Movimientos</a>
                            <a class="submenu-link" href="TipoPagos" @onclick="CloseAllMenus"><i class="bi bi-tags-fill"></i> Tipo de Pagos</a>
                        </div>
                    }
                </div>

                <a class="nav-link" href="Pedidos1">
                    <i class="bi bi-cart-check-fill"></i> Centro de Pedidos
                </a>

                <a class="nav-link" href="movimientosCaja">
                    <i class="bi bi-graph-up"></i> Reportes
                </a>

            </Authorized>
        </AuthorizeView>

        <a href="http://localhost:5258/swagger" target="_blank" class="nav-link">
            <i class="bi bi-file-code-fill"></i> Swagger API
        </a>

        <div class="user-actions">
            <a class="nav-link papelera-link" href="Papelera">
                <i class="bi bi-trash-fill"></i> Papelera
            </a>
        </div>

    </div>

    <!-- Footer -->
    <div class="navmenu-footer">
        <AuthorizeView>
            <Authorized>
                <div class="logout-container">
                    <ControlAutorizacion AbrirModal="AbrirModal" />
                </div>
            </Authorized>

            <NotAuthorized>
                <button class="btn btn-primary btn-sm w-100 mb-2" @onclick="AbrirLoginModal">
                    <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                </button>

                <button class="btn btn-outline-primary btn-sm w-100" @onclick="AbrirRegistroModal">
                    <i class="bi bi-person-plus-fill"></i> Crear Cuenta
                </button>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

@if (mostrarModal)
{
    <div class="modal-backdrop show" @onclick="CerrarModal"></div>
    <div class="modal show d-block">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@tituloModal</h5>
                    <button class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    @contenidoModal
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool showCatalogMenu;
    private bool showCajaMenu;

    private bool mostrarModal;
    private string tituloModal = "";
    private RenderFragment? contenidoModal;

    private void ToggleCatalogMenu()
    {
        showCatalogMenu = !showCatalogMenu;
        showCajaMenu = false;
    }

    private void ToggleCajaMenu()
    {
        showCajaMenu = !showCajaMenu;
        showCatalogMenu = false;
    }

    private void CloseAllMenus()
    {
        showCatalogMenu = false;
        showCajaMenu = false;
    }

    private void AbrirModal(string tipoModal)
    {
        mostrarModal = true;

        switch (tipoModal)
        {
            case "login":
                tituloModal = "Iniciar Sesión - Onlyou";
                contenidoModal = RenderLogin;
                break;
            case "registrar":
                tituloModal = "Registrarse - Onlyou";
                contenidoModal = RenderRegistro;
                break;
            case "logout":
                tituloModal = "Cerrar Sesión";
                contenidoModal = RenderLogout;
                break;
        }
    }

    private void CerrarModal() => mostrarModal = false;
    private void AbrirLoginModal() => AbrirModal("login");
    private void AbrirRegistroModal() => AbrirModal("registrar");

    private void RenderLogin(RenderTreeBuilder builder)
    {
        builder.OpenComponent<Login>(0);
        builder.AddAttribute(1, "OnClose", EventCallback.Factory.Create(this, CerrarModal));
        builder.CloseComponent();
    }

    private void RenderRegistro(RenderTreeBuilder builder)
    {
        builder.OpenComponent<Registrar>(0);
        builder.AddAttribute(1, "OnClose", EventCallback.Factory.Create(this, CerrarModal));
        builder.CloseComponent();
    }

    private void RenderLogout(RenderTreeBuilder builder)
    {
        builder.OpenComponent<Logout>(0);
        builder.AddAttribute(1, "OnClose", EventCallback.Factory.Create(this, CerrarModal));
        builder.CloseComponent();
    }

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += (sender, args) => CloseAllMenus();
    }
}