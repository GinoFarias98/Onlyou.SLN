@if (Mostrar)
{
    <div class="modal-fondo">
        <div class="modal-contenido">
            <h3>@Titulo</h3>
            @foreach (var campo in Campos)
            {
                <div class="mb-2">
                    <label>@campo.Label</label>

                    @if (campo.EsImagen)
                    {
                        <InputFile OnChange="(e) => SubirImagen(e, campo)"
                                   class="form-control"
                                   disabled="@campo.SoloLectura" />

                        @if (!string.IsNullOrEmpty(campo.Valor))
                        {
                            <div class="mt-2">
                                <img src="@($"data:image/{campo.Extension};base64,{campo.Valor}")" width="80" />
                            </div>
                        }
                    }
                    else if (campo.TipoCampo == TipoCampo.Select && campo.Opciones != null)
                    {
                        <InputSelect class="form-control"
                                     @bind-Value="campo.Valor"
                                     disabled="@campo.SoloLectura">
                            <option value="">Seleccione...</option>
                            @foreach (var op in campo.Opciones)
                            {
                                <option value="@op">@op</option>
                            }
                        </InputSelect>
                    }
                    else
                    {
                        <input class="form-control"
                               @bind="campo.Valor"
                               placeholder="@campo.Placeholder"
                               readonly="@campo.SoloLectura" />
                    }
                </div>
            }


            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-success" @onclick="Guardar">Guardar</button>
                <button class="btn btn-secondary" @onclick="Cerrar">Cancelar</button>
            </div>
        </div>
    </div>
}

@code {
    // Tipo de campo para controlar input de texto o select
    public enum TipoCampo
    {
        Texto,
        Select
    }

    public class CampoModal
    {
        public string Label { get; set; } = "";
        public string Placeholder { get; set; } = "";
        public string Valor { get; set; } = "";
        public bool EsImagen { get; set; } = false;
        public string? Extension { get; set; }

        // Para combobox/select
        public TipoCampo TipoCampo { get; set; } = TipoCampo.Texto;
        public List<string> Opciones { get; set; } = new();

        public bool SoloLectura { get; set; } = false;

    }

    [Parameter] public bool Mostrar { get; set; }
    [Parameter] public EventCallback<bool> MostrarChanged { get; set; }
    [Parameter] public string Titulo { get; set; } = "Nueva entidad";
    [Parameter] public List<CampoModal> Campos { get; set; } = new();
    [Parameter] public EventCallback<Dictionary<string, string>> EntidadCreada { get; set; }

    private async Task Guardar()
    {
        var datos = new Dictionary<string, string>();

        foreach (var campo in Campos)
        {
            if (campo.EsImagen && !string.IsNullOrEmpty(campo.Valor))
            {
                datos["ImagenBase64"] = campo.Valor;
                datos["ImagenExtension"] = campo.Extension!;
            }
            else
            {
                datos[campo.Label] = campo.Valor;
            }
        }

        await EntidadCreada.InvokeAsync(datos);
        await Cerrar();
    }

    private async Task SubirImagen(InputFileChangeEventArgs e, CampoModal campo)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);

        campo.Valor = Convert.ToBase64String(buffer);
        campo.Extension = Path.GetExtension(file.Name);
    }

    private async Task Cerrar()
    {
        Mostrar = false;
        await MostrarChanged.InvokeAsync(Mostrar);
        Campos.ForEach(c => { c.Valor = ""; c.Extension = null; });
    }
}
