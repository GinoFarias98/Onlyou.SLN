@page "/productosV2/crear"
@page "/productosV2/editar/{id:int}"

@using Onlyou.Client.Helpers
@using Onlyou.Shared.DTOS.Producto
@using Onlyou.Shared.DTOS.Categorias
@using Onlyou.Shared.DTOS.Color
@using Onlyou.Shared.DTOS.Marca
@using Onlyou.Shared.DTOS.Proveedor
@using Onlyou.Shared.DTOS.Talle
@using Onlyou.Shared.DTOS.TipoProducto
@inject IHttpServicios http
@inject SweetAlertService swal
@inject NavigationManager nav

<PageTitle>@(id == 0 ? "Crear Producto" : "Editar Producto")</PageTitle>

<style>

    /* HEADER*/
    .header-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        color: white;
        padding: 2rem;
        margin-bottom: 2rem;
    }
</style>
<div class="container-fluid py-4">
    <!-- HEADER MODERNO -->
    <div class="header-modern">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold mb-2">
                    <i class="fas @(id == 0 ? "fa-plus-circle" : "fa-edit") me-2"></i>
                    @(id == 0 ? "Crear Nuevo Producto" : $"Editar Producto #{id}")
                </h1>
            </div>
            <button @onclick="Volver" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <!-- SECCIÓN INFORMACIÓN BÁSICA -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Información Básica
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Nombre del Producto *</label>
                            <input @bind="nombre"
                                   placeholder="Ej: Remera Algodón Premium"
                                   class="form-control" />
                            <div class="form-text">Nombre descriptivo del producto</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Código *</label>
                            <input @bind="codigo"
                                   placeholder="Ej: REM-001"
                                   class="form-control" />
                            <div class="form-text">Código único de identificación</div>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-semibold">Descripción</label>
                            <textarea @bind="descripcion"
                                      placeholder="Describe las características del producto..."
                                      class="form-control"
                                      rows="3"></textarea>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Stock Inicial</label>
                            <input type="number" @bind="stock"
                                   class="form-control"
                                   min="0" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Costo *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" @bind="costo"
                                       class="form-control"
                                       placeholder="0.00" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Precio de Venta *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" @bind="precio"
                                       class="form-control"
                                       placeholder="0.00" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN RELACIONES -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-link text-primary me-2"></i>
                        Relaciones y Categorización
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Proveedor</label>
                            <div class="input-group">
                                <select @bind="proveedorId" class="form-select">
                                    <option value="">-- Seleccionar Proveedor --</option>
                                    @foreach (var p in proveedores)
                                    {
                                        <option value="@p.Id">@p.Nombre</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-primary" @onclick='() => AbrirModalEntidad("Proveedor")'>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Categoría</label>
                            <div class="input-group">
                                <select @bind="categoriaId" class="form-select">
                                    <option value="">-- Seleccionar Categoría --</option>
                                    @foreach (var c in categorias)
                                    {
                                        <option value="@c.Id">@c.Nombre</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-primary" @onclick='() => AbrirModalEntidad("Categoría")'>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Marca</label>
                            <div class="input-group">
                                <select @bind="marcaId" class="form-select">
                                    <option value="">-- Seleccionar Marca --</option>
                                    @foreach (var m in marcas)
                                    {
                                        <option value="@m.Id">@m.Nombre</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-primary" @onclick='() => AbrirModalEntidad("Marca")'>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tipo de Producto</label>
                            <select @bind="tipoProductoId" class="form-select">
                                <option value="">-- Seleccionar Tipo --</option>
                                @foreach (var t in tiposProducto)
                                {
                                    <option value="@t.Id">@t.Nombre</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN VARIANTES -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group text-primary me-2"></i>
                        Variantes del Producto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-semibold mb-3">Colores Disponibles</label>
                            <SelectorMultiple NoSeleccionados="ColoresNoSeleccionados"
                                              @bind-Seleccionados="ColoresSeleccionados" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold mb-3">Talles Disponibles</label>
                            <SelectorMultiple NoSeleccionados="TallesNoSeleccionados"
                                              @bind-Seleccionados="TallesSeleccionados" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="col-lg-4">
            <!-- IMAGEN DEL PRODUCTO -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-image text-primary me-2"></i>
                        Imagen del Producto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        @if (!string.IsNullOrEmpty(imagenBase64))
                        {
                            <!-- Imagen subida recientemente o imagen actual del producto -->
                            <img src="data:image/@imagenExtension;base64,@imagenBase64"
                                 class="img-fluid rounded mb-3 border"
                                 style="max-height: 200px; object-fit: contain;"
                                 alt="@nombre" />
                        }
                        else if (!string.IsNullOrEmpty(productoActual?.Imagen))
                        {
                            <!-- Imagen actual del producto desde la base de datos -->
                            <img src="@productoActual.Imagen"
                                 class="img-fluid rounded mb-3 border"
                                 style="max-height: 200px; object-fit: contain;"
                                 alt="@nombre" />
                            <div class="alert alert-info alert-sm mt-2 mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Esta es la imagen actual del producto
                            </div>
                        }
                        else
                        {
                            <!-- Sin imagen -->
                            <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3"
                                 style="height: 200px;">
                                <div class="text-center">
                                    <i class="fas fa-image fa-3x text-muted mb-2"></i>
                                    <p class="text-muted small mb-0">Sin imagen</p>
                                </div>
                            </div>
                        }

                        <label class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-upload me-2"></i>
                            @(string.IsNullOrEmpty(imagenBase64) ? "Subir Nueva Imagen" : "Cambiar Imagen")
                            <InputFile OnChange="SubirImagen" style="display: none;" />
                        </label>

                       @*  @if (!string.IsNullOrEmpty(imagenBase64) || !string.IsNullOrEmpty(productoActual?.Imagen))
                        {
                            <button @onclick="EliminarImagen"
                                    class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash me-2"></i>
                                Eliminar Imagen
                            </button>
                        } *@

                        <div class="form-text mt-2">Formatos: JPG, PNG, GIF. Máx. 5MB</div>
                    </div>
                </div>
            </div>

            <!-- PUBLICACIÓN WEB -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary border-bottom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-globe text-primary me-2"></i>
                        Publicación Web
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               @bind="publicadoWeb"
                               id="publicadoWeb">
                        <label class="form-check-label fw-semibold" for="publicadoWeb">
                            Publicar en la Tienda Web
                        </label>
                    </div>
                    <div class="alert alert-info mt-3 small mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        @if (publicadoWeb)
                        {
                            <span>El producto será visible para los clientes en la tienda online</span>
                        }
                        else
                        {
                            <span>El producto será guardado pero no visible en la tienda online</span>
                        }
                    </div>
                </div>
            </div>

            <!-- ACCIONES -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button @onclick="GuardarProducto" class="btn btn-primary btn-lg py-3">
                            <i class="fas fa-save me-2"></i>
                            @(id == 0 ? "Crear Producto" : "Actualizar Producto")
                        </button>

                        <button @onclick="Volver" class="btn btn-outline-danger w-100">
                            <i class="fas fa-times me-2"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<MostrarEntidad @bind-Mostrar="mostrarModal"
                Titulo="@modalTitulo"
                Campos="camposModal"
                EntidadCreada="OnEntidadCreada" />

@code {
    #region Modal Crear Entidad
    private bool mostrarModal = false;
    private string modalTitulo = "";
    private List<MostrarEntidad.CampoModal> camposModal = new();

    private void AbrirModalEntidad(string entidad)
    {
        modalTitulo = entidad;

        camposModal = entidad switch
        {
            "Proveedor" => new List<MostrarEntidad.CampoModal>
            {
                new() { Label = "Nombre", Placeholder = "Nombre del proveedor" },
                new() { Label = "Dirección", Placeholder = "Dirección" },
                new() { Label = "Razón Social", Placeholder = "Razón Social" },
                new() { Label = "CUIT", Placeholder = "CUIT" },
                new() { Label = "Teléfono", Placeholder = "Teléfono" },
                new() { Label = "Email", Placeholder = "Email" }
            },

            "Categoría" => new List<MostrarEntidad.CampoModal>
            {
                new() { Label = "Nombre", Placeholder = "Nombre de la categoría" },
                new() { Label = "Imagen", EsImagen = true },
            },

            "Marca" => new List<MostrarEntidad.CampoModal>
            {
                new() { Label = "Nombre", Placeholder = "Nombre de la marca" }
            },

            _ => new List<MostrarEntidad.CampoModal>()
        };

        mostrarModal = true;
    }

    private async Task OnEntidadCreada(Dictionary<string, string> datos)
    {
        switch (modalTitulo)
        {
            case "Proveedor":
                var provDto = new PostProveedorDTO
                {
                    Nombre = datos["Nombre"],
                    Direccion = datos["Dirección"],
                    RazonSocial = datos["Razón Social"],
                    CUIT = datos["CUIT"],
                    Telefono = datos["Teléfono"],
                    Email = datos["Email"],
                    Estado = true
                };

                var provRes = await http.Post<PostProveedorDTO, GetProveedorDTO>("api/Proveedores", provDto);

                if (provRes.Error)
                {
                    await swal.FireAsync("Error", await provRes.ObtenerErrorAsync(), SweetAlertIcon.Error);
                    return;
                }

                proveedorId = provRes.Respuesta.Id;

                await CargarDatosRelacionados();
                mostrarModal = false;
                StateHasChanged();

                await swal.FireAsync("Éxito", "Proveedor creado correctamente", SweetAlertIcon.Success);
                break;

            case "Categoría":
                var catDto = new CrearCategoriasDTO
                {
                    Nombre = datos["Nombre"],
                    Imagen = datos.ContainsKey("ImagenBase64") ? datos["ImagenBase64"] : null,
                    ImagenExtension = datos.ContainsKey("ImagenExtension") ? datos["ImagenExtension"] : Path.GetExtension(datos["ImagenNombre"])
                };

                var catRes = await http.Post<CrearCategoriasDTO, GetCategoriasDTO>("api/Categorias", catDto);

                if (catRes.Error)
                {
                    await swal.FireAsync("Error", await catRes.ObtenerErrorAsync(), SweetAlertIcon.Error);
                    return;
                }

                categoriaId = catRes.Respuesta.Id;

                await CargarDatosRelacionados();
                mostrarModal = false;
                StateHasChanged();

                await swal.FireAsync("Éxito", "Categoría creada correctamente", SweetAlertIcon.Success);
                break;

            case "Marca":
                var marcaDto = new PostMarcaDTO
                {
                    Nombre = datos["Nombre"],
                    Estado = true
                };

                var marcaRes = await http.Post<PostMarcaDTO, GetMarcaDTO>("api/Marca", marcaDto);

                if (marcaRes.Error)
                {
                    await swal.FireAsync("Error", await marcaRes.ObtenerErrorAsync(), SweetAlertIcon.Error);
                    return;
                }

                marcaId = marcaRes.Respuesta.Id;

                await CargarDatosRelacionados();
                mostrarModal = false;
                StateHasChanged();

                await swal.FireAsync("Éxito", "Marca creada correctamente", SweetAlertIcon.Success);
                break;
        }
    }
    #endregion

    [Parameter] public int id { get; set; }

    private List<GetProveedorDTO> proveedores = new();
    private List<GetCategoriasDTO> categorias = new();
    private List<GetTipoProductoDTO> tiposProducto = new();
    private List<GetMarcaDTO> marcas = new();
    private List<GetColorDTO> coloresDisponibles = new();
    private List<TallesDTO> tallesDisponibles = new();

    private List<SelectorMultipleModel> ColoresSeleccionados = new();
    private List<SelectorMultipleModel> ColoresNoSeleccionados = new();
    private List<SelectorMultipleModel> TallesSeleccionados = new();
    private List<SelectorMultipleModel> TallesNoSeleccionados = new();

    private string nombre = string.Empty;
    private string codigo = string.Empty;
    private string? descripcion;
    private int stock;
    private decimal costo;
    private decimal precio;
    private int proveedorId;
    private int categoriaId;
    private int tipoProductoId;
    private int marcaId;
    private string? imagenBase64;
    private string? imagenExtension;
    private bool publicadoWeb = false;

    // Variable para almacenar el producto actual al editar
    private GetProductoDTO? productoActual;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosRelacionados();

        if (id != 0)
        {
            var res = await http.Get<GetProductoDTO>($"Productos/Id/{id}");
            if (!res.Error && res.Respuesta != null)
            {
                productoActual = res.Respuesta;
                var p = productoActual;

                nombre = p.Nombre;
                codigo = p.Codigo;
                descripcion = p.Descripcion;
                stock = p.Stock;
                costo = p.Costo;
                precio = p.Precio;
                proveedorId = p.ProveedorId;
                categoriaId = p.CategoriaId;
                tipoProductoId = p.TipoProductoId;
                marcaId = p.MarcaId;
                publicadoWeb = p.PublicadoWeb;

                ColoresSeleccionados = coloresDisponibles
                    .Where(c => p.Colores.Contains(c.Id))
                    .Select(c => new SelectorMultipleModel(c.Id.ToString(), c.Nombre, c.Hexadecimal))
                    .ToList();

                ColoresNoSeleccionados = coloresDisponibles
                    .Where(c => !p.Colores.Contains(c.Id))
                    .Select(c => new SelectorMultipleModel(c.Id.ToString(), c.Nombre, c.Hexadecimal))
                    .ToList();

                TallesSeleccionados = tallesDisponibles
                    .Where(t => p.Talles.Contains(t.Id))
                    .Select(t => new SelectorMultipleModel(t.Id.ToString(), t.Nombre))
                    .ToList();

                TallesNoSeleccionados = tallesDisponibles
                    .Where(t => !p.Talles.Contains(t.Id))
                    .Select(t => new SelectorMultipleModel(t.Id.ToString(), t.Nombre))
                    .ToList();
            }
        }
        else
        {
            ColoresNoSeleccionados = coloresDisponibles
                .Select(c => new SelectorMultipleModel(c.Id.ToString(), c.Nombre, c.Hexadecimal)).ToList();

            TallesNoSeleccionados = tallesDisponibles
                .Select(t => new SelectorMultipleModel(t.Id.ToString(), t.Nombre)).ToList();
        }
    }

    private async Task CargarDatosRelacionados()
    {
        proveedores = (await http.Get<List<GetProveedorDTO>>("api/Proveedores")).Respuesta ?? new();
        categorias = (await http.Get<List<GetCategoriasDTO>>("api/Categorias")).Respuesta ?? new();
        tiposProducto = (await http.Get<List<GetTipoProductoDTO>>("api/TipoProducto")).Respuesta ?? new();
        marcas = (await http.Get<List<GetMarcaDTO>>("api/Marca")).Respuesta ?? new();
        coloresDisponibles = (await http.Get<List<GetColorDTO>>("api/ManageColor")).Respuesta ?? new();
        tallesDisponibles = (await http.Get<List<TallesDTO>>("api/Talle")).Respuesta ?? new();
    }

    private async Task GuardarProducto()
    {
        var coloresSeleccionados = ColoresSeleccionados.Select(x => int.Parse(x.Llave)).ToList();
        var tallesSeleccionados = TallesSeleccionados.Select(x => int.Parse(x.Llave)).ToList();

        if (id == 0)
        {
            var dto = new PostProductoDTO
            {
                Nombre = nombre,
                Codigo = codigo,
                Descripcion = descripcion,
                Stock = stock,
                Costo = costo,
                Precio = precio,
                ProveedorId = proveedorId,
                CategoriaId = categoriaId,
                TipoProductoId = tipoProductoId,
                MarcaId = marcaId,
                Imagen = imagenBase64,
                ImagenExtension = imagenExtension,
                Colores = coloresSeleccionados,
                Talles = tallesSeleccionados,
                PublicadoWeb = publicadoWeb
            };

            var r = await http.Post<PostProductoDTO, GetProductoDTO>("Productos", dto);
            if (!r.Error)
            {
                var mensaje = publicadoWeb ? "Producto creado y publicado en la web correctamente"
                                           : "Producto creado correctamente";
                await swal.FireAsync("Éxito", mensaje, SweetAlertIcon.Success);
                Volver();
            }
            else
            {
                await swal.FireAsync("Error", await r.ObtenerErrorAsync(), SweetAlertIcon.Error);
            }
        }
        else
        {
            var dto = new PutProductoDTO
            {
                Nombre = nombre,
                Codigo = codigo,
                Descripcion = descripcion,
                Stock = stock,
                Costo = costo,
                Precio = precio,
                ProveedorId = proveedorId,
                CategoriaId = categoriaId,
                TipoProductoId = tipoProductoId,
                MarcaId = marcaId,
                Imagen = imagenBase64,
                ImagenExtension = imagenExtension,
                Colores = coloresSeleccionados,
                Talles = tallesSeleccionados,
                PublicadoWeb = publicadoWeb
            };

            var r = await http.Put<PutProductoDTO, GetProductoDTO>($"Productos/{id}", dto);
            if (!r.Error)
            {
                var mensaje = publicadoWeb ? "Producto actualizado y publicado en la web correctamente"
                                           : "Producto actualizado correctamente";
                await swal.FireAsync("Éxito", mensaje, SweetAlertIcon.Success);
                Volver();
            }
            else
            {
                await swal.FireAsync("Error", await r.ObtenerErrorAsync(), SweetAlertIcon.Error);
            }
        }
    }

    private async Task SubirImagen(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);
        imagenBase64 = Convert.ToBase64String(buffer);
        imagenExtension = Path.GetExtension(file.Name);
        StateHasChanged();
    }

    private void EliminarImagen()
    {
        imagenBase64 = null;
        imagenExtension = null;
        StateHasChanged();
    }

    private void Volver() => nav.NavigateTo("/productosV2");
}