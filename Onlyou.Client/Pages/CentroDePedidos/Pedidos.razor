@page "/Pedidos1"
@inject HttpClient Http
@inject NavigationManager Navigation
@using Onlyou.Shared.DTOS.Pedidos
@using Onlyou.Shared.DTOS.Pedidos.EstadoPedido


<h3>Gestión de Pedidos</h3>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label">Filtrar por Estado:</label>
        <select @bind="filtroEstadoId" @bind:event="onchange" class="form-select">
            <option value="">Todos los estados</option>
            @if (estadosPedido != null)
            {
                @foreach (var estado in estadosPedido)
                {
                    <option value="@estado.Id">@estado.Nombre</option>
                }
            }
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Buscar por Cliente:</label>
        <input @bind="filtroCliente" @bind:event="oninput" class="form-control" placeholder="Nombre del cliente..." />
    </div>
    <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">Limpiar Filtros</button>
    </div>
</div>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando pedidos...</p>
    </div>
}
else if (pedidos == null || !pedidos.Any())
{
    <div class="alert alert-info text-center">
        <h5>No hay pedidos</h5>
        <p>No se encontraron pedidos con los filtros aplicados.</p>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>DNI</th>
                    <th>Teléfono</th>
                    <th>Localidad</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Entrega</th>
                    <th>Pago</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var pedido in pedidosFiltrados)
                {
                    <tr>
                        <td>
                            <strong>#@pedido.Id</strong>
                            @if (pedido.Descripcion?.Contains("web") == true)
                            {
                                <span class="badge bg-info ms-1" title="Pedido desde la web">🌐</span>
                            }
                        </td>
                        <td>@pedido.NombreCliente</td>
                        <td>@pedido.DNI</td>
@*                         <td>
                            @if (!string.IsNullOrEmpty(pedido.Telefono))
                            {
                                <a href="https://wa.me/@pedido.Telefono" target="_blank" class="btn btn-sm btn-success">
                                    📞 @pedido.Telefono
                                </a>
                            }
                        </td> *@
                        <td>@pedido.Localidad</td>
                        <td>
                            <strong class="text-success">$@pedido.MontoTotal.ToString("N2")</strong>
                        </td>
                        <td>
                            <span class="badge @GetBadgeClass(pedido.EstadoPedidoNombre)">
                                @pedido.EstadoPedidoNombre
                            </span>
                        </td>
                        <td>
                            <span class="badge @GetEntregaBadgeClass(pedido.EstadoEntrega)">
                                @GetTextoEstadoEntrega(pedido.EstadoEntrega)
                            </span>
                        </td>
                        <td>
                            <span class="badge @GetPagoBadgeClass(pedido.EstadoPago)">
                                $@pedido.MontoPagado.ToString("N2") / $@pedido.MontoTotal.ToString("N2")
                            </span>
                            @if (pedido.SaldoPendiente > 0)
                            {
                                <br />
                                <small class="text-danger">Pendiente: $@pedido.SaldoPendiente.ToString("N2")</small>
                            }
                        </td>
                        <td>
                            <small>@pedido.FechaGenerado.ToString("dd/MM/yyyy")</small><br />
                            <small class="text-muted">@pedido.FechaGenerado.ToString("HH:mm")</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" @onclick="() => VerDetalles(pedido.Id)" title="Gestionar pedido">
                                    📋
                                </button>
                                <button class="btn btn-sm btn-info" @onclick="() => VerItems(pedido)" title="Ver productos">
                                    🛍️
                                </button>
                                @if (pedido.EstadoPedidoNombre?.ToLower().Contains("pendiente") == true)
                                {
                                    <button class="btn btn-sm btn-warning" @onclick="() => MarcarComoProveedor(pedido.Id)" title="Marcar como pedido a proveedor">
                                        📦
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted">
                Mostrando @((paginaActual - 1) * tamanoPagina + 1)-@Math.Min(paginaActual * tamanoPagina, pedidosFiltrados.Count) de @pedidosFiltrados.Count pedidos
            </small>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary" @onclick="PaginaAnterior" disabled="@(paginaActual == 1)">← Anterior</button>
            <span class="mx-2">Página @paginaActual</span>
            <button class="btn btn-sm btn-outline-primary" @onclick="PaginaSiguiente" disabled="@(paginaActual* tamanoPagina >= pedidosFiltrados.Count)">Siguiente →</button>
        </div>
    </div>
}

<!-- Modal para ver items del pedido -->
@if (pedidoSeleccionado != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Productos del Pedido #@pedidoSeleccionado.Id</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Imagen</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in pedidoSeleccionado.PedidoItems)
                                {
                                    <tr>
                                        <td>@item.ProductoNombre</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.ProductoImagen))
                                            {
                                                <img src="@item.ProductoImagen" alt="@item.ProductoNombre" style="width: 50px; height: 50px; object-fit: cover;" />
                                            }
                                            else
                                            {
                                                <div style="width: 50px; height: 50px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                                    🏷️
                                                </div>
                                            }
                                        </td>
                                        <td>@item.Cantidad</td>
                                        <td>$@item.PrecioUnitarioVenta.ToString("N2")</td>
                                        <td><strong>$@item.SubTotal.ToString("N2")</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td><strong>$@pedidoSeleccionado.MontoTotal.ToString("N2")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cerrar</button>
                    <button type="button" class="btn btn-primary" @onclick="() => VerDetalles(pedidoSeleccionado.Id)">Gestionar Pedido</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<GetPedidosDTO> pedidos = new();
    private List<GetPedidosDTO> pedidosFiltrados = new();
    private List<EstadoPedidoDTO> estadosPedido = new();
    private GetPedidosDTO? pedidoSeleccionado;

    private string filtroCliente = "";
    private int? filtroEstadoId
    {
        get => _filtroEstadoId;
        set
        {
            _filtroEstadoId = value;
            AplicarFiltros();
            StateHasChanged();
        }
    }
    private int? _filtroEstadoId;

    private bool cargando = true;
    private int paginaActual = 1;
    private int tamanoPagina = 10;

    protected override async Task OnInitializedAsync()
    {
        await CargarEstadosPedido();
        await CargarPedidos();
    }

    private async Task CargarEstadosPedido()
    {
        try
        {
            estadosPedido = await Http.GetFromJsonAsync<List<EstadoPedidoDTO>>("api/Pedidos/Estados") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar estados: {ex.Message}");
            // Si hay error, inicializar con lista vacía
            estadosPedido = new List<EstadoPedidoDTO>();
        }
    }

    private async Task CargarPedidos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var url = "api/Pedidos";
            pedidos = await Http.GetFromJsonAsync<List<GetPedidosDTO>>(url) ?? new();
            AplicarFiltros();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar pedidos: {ex.Message}");
            pedidos = new List<GetPedidosDTO>();
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private void AplicarFiltros()
    {
        var query = pedidos.AsEnumerable();

        if (!string.IsNullOrEmpty(filtroCliente))
        {
            query = query.Where(p => p.NombreCliente.Contains(filtroCliente, StringComparison.OrdinalIgnoreCase));
        }

        if (_filtroEstadoId.HasValue)
        {
            query = query.Where(p => p.EstadoPedidoId == _filtroEstadoId.Value);
        }

        pedidosFiltrados = query.OrderByDescending(p => p.FechaGenerado).ToList();
        paginaActual = 1;
    }

    private void LimpiarFiltros()
    {
        filtroCliente = "";
        _filtroEstadoId = null;
        AplicarFiltros();
        StateHasChanged();
    }

    private void VerDetalles(int pedidoId)
    {
        Navigation.NavigateTo($"/pedido-detalle/{pedidoId}");
    }

    private void VerItems(GetPedidosDTO pedido)
    {
        pedidoSeleccionado = pedido;
        StateHasChanged();
    }

    private async Task MarcarComoProveedor(int pedidoId)
    {
        try
        {
            var response = await Http.PatchAsync($"api/Pedidos/MarcarProveedor/{pedidoId}", null);
            if (response.IsSuccessStatusCode)
            {
                await CargarPedidos();
                // Aquí podrías agregar una notificación de éxito
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al marcar como pedido a proveedor: {ex.Message}");
        }
    }

    private void CerrarModal()
    {
        pedidoSeleccionado = null;
        StateHasChanged();
    }

    private void PaginaAnterior()
    {
        if (paginaActual > 1)
        {
            paginaActual--;
        }
    }

    private void PaginaSiguiente()
    {
        if (paginaActual * tamanoPagina < pedidosFiltrados.Count)
        {
            paginaActual++;
        }
    }

    private string GetBadgeClass(string estadoNombre)
    {
        return estadoNombre?.ToLower() switch
        {
            "pendiente" or "nuevo" => "bg-warning text-dark",
            "confirmado" or "en proceso" => "bg-info",
            "pedido a proveedor" or "en preparación" => "bg-primary",
            "listo" or "completo" => "bg-success",
            "entregado" => "bg-secondary",
            "cancelado" => "bg-danger",
            _ => "bg-light text-dark"
        };
    }

    private string GetEntregaBadgeClass(int estado)
    {
        return estado switch
        {
            0 => "bg-warning text-dark",    // NoEntregado
            1 => "bg-info",                 // Parcial
            2 => "bg-success",              // Completo
            _ => "bg-light text-dark"
        };
    }

    private string GetPagoBadgeClass(int estado)
    {
        return estado switch
        {
            0 => "bg-danger",               // NoPagado
            1 => "bg-warning text-dark",    // Parcial
            2 => "bg-success",              // Pagado
            _ => "bg-light text-dark"
        };
    }

    private string GetTextoEstadoEntrega(int estado)
    {
        return estado switch
        {
            0 => "No Entregado",
            1 => "Parcial",
            2 => "Completo",
            _ => "Desconocido"
        };
    }
}